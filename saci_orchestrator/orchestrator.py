from typing import List
from dotenv import load_dotenv

load_dotenv()


class SACIOrchestrator:
    def __init__(self):
        self.current_goal = None
        self.tasks = []

    def set_goal(self, goal: str) -> None:
        self.current_goal = goal
        print(f"[SACI Orchestrator] Goal set to: {self.current_goal}")

    def plan_tasks(self) -> List[str]:
        if not self.current_goal:
            print("[SACI Orchestrator] No goal set. Unable to plan tasks.")
            return []

        self.tasks = [
            "Analyze goal and create code skeleton",
            "Generate code via AI agent",
            "Run tests against generated code",
            "Integrate code to GitHub if tests pass",
            "Deploy to environment if integration is successful",
        ]

        print(f"[SACI Orchestrator] Planned tasks for goal '{self.current_goal}':")
        for i, task in enumerate(self.tasks, start=1):
            print(f"  {i}. {task}")
        return self.tasks

    def execute_tasks(self) -> None:
        if not self.tasks:
            print("[SACI Orchestrator] No tasks to execute.")
            return

        print("[SACI Orchestrator] Executing tasks...")
        for i, task in enumerate(self.tasks, start=1):
            print(f"  {i}. {task} [Executed]")

        self.generate_code()
        self.tasks = []

    def generate_code(self) -> None:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–µ–ª–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª –≤ GitHub.
        """
        import os

        try:
            from github import Github
        except ImportError:
            print("[SACI] –£—Å—Ç–∞–Ω–æ–≤–∏ PyGithub: pip install PyGithub")
            return

        token = os.getenv("GITHUB_TOKEN")
        username = os.getenv("GITHUB_USERNAME")
        repo_name = os.getenv("GITHUB_REPO")

        if not token or not username or not repo_name:
            print("[SACI] GitHub –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –∑–∞–¥–∞–Ω—ã.")
            return

        goal = self.current_goal.lower()
        if any(word in goal for word in ["–±–æ—Ç", "telegram", "—á–∞—Ç"]):
            filename = "telegram_bot.py"
            content = (
                "# Telegram Bot generated by SACI\n"
                "# –¶–µ–ª—å: " + self.current_goal + "\n\n"
                "from telegram.ext import Application, CommandHandler\n\n"
                "async def start(update, context):\n"
                "    await update.message.reply_text('–ü—Ä–∏–≤–µ—Ç –æ—Ç SACI-–±–æ—Ç–∞!')\n\n"
                "app = Application.builder().token('YOUR_TOKEN').build()\n"
                "app.add_handler(CommandHandler('start', start))\n"
                "app.run_polling()\n"
            )
        elif any(word in goal for word in ["–ø–∞—Ä—Å–µ—Ä", "—Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å", "html", "—Å–∞–π—Ç"]):
            filename = "parser.py"
            content = (
                "# HTML Parser generated by SACI\n"
                "# –¶–µ–ª—å: " + self.current_goal + "\n\n"
                "import requests\n"
                "from bs4 import BeautifulSoup\n\n"
                "url = 'https://example.com'\n"
                "response = requests.get(url)\n"
                "soup = BeautifulSoup(response.text, 'html.parser')\n"
                "print(soup.title.text)\n"
            )
        elif any(word in goal for word in ["api", "—Å–µ—Ä–≤–µ—Ä", "endpoint", "—Ñ—Ä–µ–π–º–≤–æ—Ä–∫"]):
            filename = "api_server.py"
            content = (
                "# Flask API generated by SACI\n"
                "# –¶–µ–ª—å: " + self.current_goal + "\n\n"
                "from flask import Flask, jsonify\n\n"
                "app = Flask(__name__)\n\n"
                "@app.route('/')\n"
                "def index():\n"
                "    return jsonify({'message': '–ü—Ä–∏–≤–µ—Ç –æ—Ç SACI API'})\n\n"
                "if __name__ == '__main__':\n"
                "    app.run(debug=True)\n"
            )
        else:
            filename = "main.py"
            content = (
                "# Generated by SACI\n"
                "# Goal: " + self.current_goal + "\n\n"
                "print('Hello from SACI!')\n"
            )

        try:
            from github import Github

            g = Github(token)
            user = g.get_user()
            repo = user.get_repo(repo_name)
            try:
                file = repo.get_contents(filename)
                repo.update_file(
                    filename,
                    f"SACI code update for goal: {self.current_goal}",
                    content,
                    file.sha,
                )
                print(
                    f"[SACI] {filename} –æ–±–Ω–æ–≤–ª—ë–Ω –≤ GitHub. –ü—Ä–∏—á–∏–Ω–∞: {self.current_goal}"
                )
            except:
                repo.create_file(
                    filename, f"SACI code create for goal: {self.current_goal}", content
                )
                print(
                    f"[SACI] {filename} —Å–æ–∑–¥–∞–Ω –≤ GitHub. –ü—Ä–∏—á–∏–Ω–∞: {self.current_goal}"
                )
        except Exception as e:
            print(f"[SACI] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É—à–µ –∫–æ–¥–∞ –≤ GitHub: {e}")


import os
import requests
import base64
import subprocess
from datetime import datetime


class GitHubAgent:
    def __init__(self, token, repo, username):
        self.token = token
        self.repo = repo
        self.username = username
        self.api_url = f"https://api.github.com/repos/{username}/{repo}/contents"

    def update_file(self, path, content, commit_message):
        url = f"{self.api_url}/{path}"
        headers = {
            "Authorization": f"Bearer {self.token}",
            "Accept": "application/vnd.github+json",
        }

        response = requests.get(url, headers=headers)
        sha = response.json()["sha"] if response.status_code == 200 else None

        data = {
            "message": commit_message,
            "content": base64.b64encode(content.encode()).decode(),
            "branch": "main",
        }
        if sha:
            data["sha"] = sha

        response = requests.put(url, headers=headers, json=data)
        if response.status_code in [200, 201]:
            print(f"‚úÖ –§–∞–π–ª {path} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—à–µ–Ω –≤ GitHub")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ push: {response.status_code} ‚Üí {response.json()}")

    def commit_from_bot(self, file, content, message):
        url = f"{self.api_url}/{file}"
        headers = {
            "Authorization": f"Bearer {self.token}",
            "Accept": "application/vnd.github+json",
        }

        response = requests.get(url, headers=headers)
        sha = response.json().get("sha") if response.status_code == 200 else None

        commit_msg = f"{message}\n\nüß† SACI-Agent ‚Ä¢ {datetime.utcnow().isoformat()}Z"

        data = {
            "message": commit_msg,
            "content": base64.b64encode(content.encode()).decode(),
            "branch": "main",
        }
        if sha:
            data["sha"] = sha

        result = requests.put(url, headers=headers, json=data)
        if result.status_code in [200, 201]:
            print(f"‚úÖ SACI-–∫–æ–º–º–∏—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Üí {file}")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–º–∏—Ç–∞ SACI ({result.status_code}): {result.json()}")

    def sync_after_commit(self):
        print("üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å GitHub...")

        try:
            # –ê–≤—Ç–æ–∫–æ–º–º–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–¥ pull
            subprocess.run(["git", "add", "."], check=True)
            subprocess.run(
                ["git", "commit", "-m", "SACI: –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ pull"], check=True
            )

            output = subprocess.check_output(
                ["git", "pull", "--no-rebase", "origin", "main"],
                stderr=subprocess.STDOUT,
                universal_newlines=True,
            )
            print(f"‚úÖ Pull —É—Å–ø–µ—à–µ–Ω:\n{output}")
        except subprocess.CalledProcessError as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ pull:\n{e.output}")

    def commit_with_log(self, file, content, message, log_file="SACI_LOG_TEMPLATE.md"):
        self.commit_from_bot(file=file, content=content, message=message)

        timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%SZ")
        log_entry = (
            "### üß† SACI-Agent\n"
            f"üïí {timestamp}\n"
            f"üéØ {message}\n"
            "üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è:\n"
            f"- `{file}` –æ–±–Ω–æ–≤–ª—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n"
        )

        try:
            if os.path.exists(log_file):
                with open(log_file, "r", encoding="utf-8") as f:
                    existing = f.read()
            else:
                existing = "# SACI Commit Log üìò\n"

            updated_log = existing.strip() + "\n\n" + log_entry.strip() + "\n"

            with open(log_file, "w", encoding="utf-8") as f:
                f.write(updated_log)

            self.commit_from_bot(
                file=log_file,
                content=updated_log,
                message=f"–û–±–Ω–æ–≤–ª—ë–Ω SACI-–ª–æ–≥ –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ {file}",
            )

            self.sync_after_commit()

        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ SACI-–ª–æ–≥–∞: {e}")
